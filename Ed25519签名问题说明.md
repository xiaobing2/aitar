# Ed25519签名验证问题说明

## 🔴 问题根源

QQ官方**严格要求**使用 **Ed25519** 算法进行签名验证，而当前实现使用的是 **HMAC-SHA256**，导致验证失败。

## 📋 QQ官方要求

1. **算法**：必须使用 Ed25519
2. **Seed**：使用 AppSecret 作为 seed 生成 Ed25519 密钥对
3. **消息**：签名消息 = `event_ts + plain_token`（字符串拼接）
4. **格式**：返回 hex 格式的签名（64字节 = 128个hex字符）

## ⚠️ 当前实现的问题

Web Crypto API 在边缘函数环境中的限制：
- ✅ 支持生成 Ed25519 密钥对
- ❌ **不支持从 seed 导入 Ed25519 密钥**
- ❌ 只能生成随机密钥对，无法使用 secret 作为 seed

## 🔧 解决方案

### 方案1: 使用纯JavaScript Ed25519实现（推荐）

由于边缘函数环境限制，需要实现一个纯JavaScript的Ed25519算法。

**实现步骤：**
1. 将 Ed25519 算法用纯 JavaScript 实现
2. 使用 secret 作为 seed 生成密钥对
3. 对消息进行签名

**参考实现：**
```javascript
// 需要实现Ed25519的核心算法
// 1. 从seed生成密钥对
// 2. 签名消息
// 3. 返回hex格式签名
```

### 方案2: 使用Cloudflare Workers

Cloudflare Workers 原生支持 Ed25519，可以：
1. 将 webhook.js 部署到 Cloudflare Workers
2. 使用 Cloudflare 的 Ed25519 API
3. 配置QQ回调地址指向 Cloudflare Workers

### 方案3: 使用Node.js后端服务器

如果边缘函数限制太多：
1. 部署一个 Node.js 后端服务器
2. 使用 `@noble/ed25519` 或 `tweetnacl` 库
3. 实现正确的 Ed25519 签名
4. 配置QQ回调地址指向后端服务器

## 🎯 推荐方案

**最佳方案：实现纯JavaScript Ed25519**

由于ESA边缘函数的限制，建议：
1. 使用纯JavaScript实现Ed25519算法
2. 或者使用支持Ed25519的其他边缘函数平台

## 📝 当前代码状态

当前代码已尝试使用 Web Crypto API 的 Ed25519，但可能因为无法从 seed 导入密钥而失败，会回退到 HMAC-SHA256。

**检查方法：**
查看ESA控制台的函数日志：
- 如果看到 `⚠️ Ed25519不支持，尝试HMAC-SHA256` → Ed25519实现失败
- 如果看到 `✅ Ed25519签名生成成功` → Ed25519可能工作（但密钥可能不对）

## 🔍 调试步骤

1. **查看函数日志**
   - 在ESA控制台查看函数日志
   - 确认签名生成过程
   - 检查是否有错误

2. **测试签名**
   - 使用固定的 secret、event_ts、plain_token 测试
   - 确认签名长度是128个hex字符（64字节）
   - 对比QQ官方示例

3. **验证返回格式**
   - 确保返回格式是：`{"plain_token":"xxx","signature":"xxx"}`
   - 确保 Content-Type 是 `application/json`
   - 确保状态码是 200

## 💡 临时解决方案

如果急需验证通过，可以考虑：
1. 联系QQ技术支持，询问是否可以使用HMAC-SHA256
2. 或者使用其他支持Ed25519的边缘函数平台

## 📚 参考资料

- [Ed25519算法说明](https://en.wikipedia.org/wiki/EdDSA)
- [QQ机器人文档](https://bot.q.qq.com/wiki)
- [Web Crypto API文档](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
