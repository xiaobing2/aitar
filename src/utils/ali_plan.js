/*
 * é˜¿é‡Œäº‘ DashScope ç”Ÿæˆè®¡åˆ’æ­¥éª¤
 */
import { getAlibabaApiKey } from './config'

// ä½¿ç”¨è¾¹ç¼˜å‡½æ•°ä»£ç†ï¼Œé¿å…CORSé—®é¢˜
const API_BASE_URL = process.env.VUE_APP_EDGE_API_BASE 
  ? `${process.env.VUE_APP_EDGE_API_BASE}/ali-api`
  : '/api/edge/ali-api'

function parseJSON(text) {
  try {
    // å°è¯•ç›´æ¥è§£æ
    return JSON.parse(text)
  } catch (e) {
    // å°è¯•æå–JSONéƒ¨åˆ†ï¼ˆå¤„ç†markdownä»£ç å—ç­‰ï¼‰
    const jsonMatch = text.match(/\{[\s\S]*\}/)
    if (jsonMatch) {
      try {
        return JSON.parse(jsonMatch[0])
      } catch (e2) {
        console.error('âŒ JSONè§£æå¤±è´¥:', e2)
        console.error('åŸå§‹å†…å®¹:', text)
        throw new Error('AIè¿”å›çš„JSONæ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•')
      }
    }
    console.error('âŒ æœªæ‰¾åˆ°JSONå†…å®¹:', text)
    throw new Error('AIè¿”å›æ ¼å¼é”™è¯¯ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå†…å®¹')
  }
}

export async function generatePlan(prompt) {
  const apiKey = getAlibabaApiKey()
  if (!apiKey) {
    throw new Error('æœªé…ç½®é˜¿é‡Œäº‘ API Keyï¼Œè¯·åœ¨è®¾ç½®é¡µé¢é…ç½®')
  }

  const systemPrompt = `ä½ æ˜¯ä¸“ä¸šäººç”Ÿè§„åˆ’åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·ç›®æ ‡åˆ¶å®šè¯¦ç»†çš„å¯æ‰§è¡Œè®¡åˆ’ã€‚

é‡è¦è¦æ±‚ï¼š
1. æ­¥éª¤è¦å…·ä½“åˆ°æ—¶é—´å®‰æ’ï¼ˆå¦‚"ç¬¬1-3å¤©"ã€"ç¬¬1å‘¨"ã€"æ¯å¤©"ç­‰ï¼‰
2. æ¯ä¸ªæ­¥éª¤å¿…é¡»æ˜¯ç›´æ¥å¯æ‰§è¡Œçš„è¡ŒåŠ¨ï¼Œä¸è¦åŒ…å«"åˆ¶å®šè®¡åˆ’"ã€"åˆ—å‡ºæ­¥éª¤"ã€"è§„åˆ’å†…å®¹"ç­‰å…ƒä»»åŠ¡
3. æ­¥éª¤åº”è¯¥æ˜¯å…·ä½“çš„è¡ŒåŠ¨ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·å†å»è§„åˆ’æˆ–åˆ¶å®šä»€ä¹ˆ
4. æ­¥éª¤ä¹‹é—´è¦æœ‰é€»è¾‘é¡ºåºå’Œæ—¶é—´é€’è¿›å…³ç³»
5. é’ˆå¯¹ç”¨æˆ·çš„å…·ä½“æƒ…å†µï¼ˆå¦‚èº«é«˜ä½“é‡ã€å½“å‰çŠ¶æ€ç­‰ï¼‰ç»™å‡ºä¸ªæ€§åŒ–å»ºè®®

ç¦æ­¢çš„æ­¥éª¤ç±»å‹ï¼ˆä¸è¦ç”Ÿæˆï¼‰ï¼š
- âŒ "åˆ¶å®šå†…å®¹è®¡åˆ’"ã€"åˆ—å‡ºæ­¥éª¤"ã€"åˆ›å»ºè®¡åˆ’"ã€"è§„åˆ’å†…å®¹"
- âŒ "åˆ¶å®šè®­ç»ƒè®¡åˆ’"ã€"åˆ¶å®šå­¦ä¹ è®¡åˆ’"ã€"åˆ¶å®šæ—¶é—´è¡¨"
- âœ… åº”è¯¥ç›´æ¥æ˜¯ï¼š"ä¸‹è½½Keep Appï¼Œé€‰æ‹©'å¢è‚Œè®­ç»ƒ'è¯¾ç¨‹ï¼Œæ¯å¤©30åˆ†é’Ÿ"
- âœ… åº”è¯¥ç›´æ¥æ˜¯ï¼š"è§‚çœ‹5ä¸ªåŒç±»ç½‘çº¢çš„è§†é¢‘ï¼Œè®°å½•ä»–ä»¬çš„å†…å®¹ç»“æ„å’Œé£æ ¼"

è¿”å›ä¸¥æ ¼ JSON æ ¼å¼ï¼š
{
  "title": "ä¸€å¥è¯æ€»ç»“ç›®æ ‡",
  "steps": [
    "ç¬¬1-3å¤©ï¼šå…·ä½“è¡ŒåŠ¨1ï¼ˆè¦è¯¦ç»†è¯´æ˜åšä»€ä¹ˆã€æ€ä¹ˆåšï¼Œç›´æ¥æ‰§è¡Œï¼Œä¸è¦åˆ¶å®šè®¡åˆ’ï¼‰",
    "ç¬¬4-7å¤©ï¼šå…·ä½“è¡ŒåŠ¨2ï¼ˆç›´æ¥è¡ŒåŠ¨ï¼‰",
    "ç¬¬2å‘¨ï¼šå…·ä½“è¡ŒåŠ¨3ï¼ˆç›´æ¥è¡ŒåŠ¨ï¼‰",
    ...
  ]
}

ç¤ºä¾‹æ ¼å¼ï¼ˆæ­£ç¡®ï¼‰ï¼š
- "ç¬¬1-3å¤©ï¼šä¸‹è½½Keepæˆ–Nike Training Club Appï¼Œé€‰æ‹©'å¢è‚Œè®­ç»ƒ'è¯¾ç¨‹ï¼Œæ¯å¤©30åˆ†é’Ÿå¼€å§‹è®­ç»ƒ"
- "ç¬¬4-7å¤©ï¼šæ‰§è¡Œè®­ç»ƒï¼Œå‘¨ä¸€ä¸‰äº”ç»ƒèƒ¸èƒŒï¼Œå‘¨äºŒå››å…­ç»ƒè…¿è‚©ï¼Œå‘¨æ—¥ä¼‘æ¯"
- "ç¬¬2å‘¨ï¼šå¢åŠ è®­ç»ƒå¼ºåº¦ï¼Œæ¯ç»„åŠ¨ä½œä»8æ¬¡å¢åŠ åˆ°12æ¬¡ï¼Œå¢åŠ 1ç»„è®­ç»ƒ"

ç¤ºä¾‹æ ¼å¼ï¼ˆé”™è¯¯ï¼Œä¸è¦ç”Ÿæˆï¼‰ï¼š
- âŒ "ç¬¬1-3å¤©ï¼šåˆ¶å®šè®­ç»ƒè®¡åˆ’"ï¼ˆåº”è¯¥ç›´æ¥æ˜¯å…·ä½“çš„è®­ç»ƒè¡ŒåŠ¨ï¼‰
- âŒ "ç¬¬2å‘¨ï¼šåˆ¶å®šå†…å®¹è®¡åˆ’"ï¼ˆåº”è¯¥ç›´æ¥æ˜¯å…·ä½“çš„åˆ›ä½œè¡ŒåŠ¨ï¼‰

è¯·ç¡®ä¿æ­¥éª¤æ˜¯ç›´æ¥å¯æ‰§è¡Œçš„è¡ŒåŠ¨ï¼Œä¸è¦åŒ…å«ä»»ä½•"åˆ¶å®šè®¡åˆ’"ã€"è§„åˆ’"ç­‰å…ƒä»»åŠ¡ã€‚`

  const body = {
    model: 'qwen-turbo',
    input: {
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: prompt }
      ]
    },
    parameters: { 
      temperature: 0.2,  // é™ä½æ¸©åº¦ï¼Œç”Ÿæˆæ›´ç»“æ„åŒ–çš„å†…å®¹
      max_tokens: 2000   // å¢åŠ tokené™åˆ¶ï¼Œæ”¯æŒæ›´è¯¦ç»†çš„è®¡åˆ’
    }
  }

  // é€šè¿‡è¾¹ç¼˜å‡½æ•°ä»£ç†ï¼Œé¿å…CORSé—®é¢˜
  const resp = await fetch(API_BASE_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      apiKey: apiKey,
      requestBody: body
    })
  })

  if (!resp.ok) {
    const errorData = await resp.json().catch(() => ({}))
    throw new Error(errorData.error?.message || `AI è¯·æ±‚å¤±è´¥: ${resp.status}`)
  }
  
  const data = await resp.json()
  
  // å…¼å®¹æ–°æ—§APIæ ¼å¼
  let content = ''
  if (data.output?.text) {
    // æ–°æ ¼å¼ï¼šoutput.text
    content = data.output.text
  } else if (data.output?.choices?.[0]?.message?.content) {
    // æ—§æ ¼å¼ï¼šoutput.choices[0].message.content
    content = data.output.choices[0].message.content
  } else {
    console.error('âŒ AIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸:', data)
    throw new Error('AIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œè¯·é‡è¯•')
  }
  
  if (!content) {
    throw new Error('AIè¿”å›å†…å®¹ä¸ºç©º')
  }
  
  console.log('ğŸ“ AIè¿”å›åŸå§‹å†…å®¹:', content)
  
  // è§£æJSON
  const json = parseJSON(content)
  
  // éªŒè¯å¿…è¦å­—æ®µ
  if (!json.title || !Array.isArray(json.steps)) {
    console.error('âŒ AIè¿”å›æ ¼å¼ä¸æ­£ç¡®:', json)
    throw new Error('AIè¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•')
  }
  
  // åå¤„ç†ï¼šè¿‡æ»¤å’Œæ›¿æ¢åŒ…å«"åˆ¶å®šè®¡åˆ’"ç­‰è‡ªç›¸çŸ›ç›¾çš„æ­¥éª¤
  const forbiddenKeywords = [
    'åˆ¶å®šå†…å®¹è®¡åˆ’', 'åˆ¶å®šè®¡åˆ’', 'åˆ—å‡ºæ­¥éª¤', 'åˆ›å»ºè®¡åˆ’', 'è§„åˆ’å†…å®¹',
    'åˆ¶å®šè®­ç»ƒè®¡åˆ’', 'åˆ¶å®šå­¦ä¹ è®¡åˆ’', 'åˆ¶å®šæ—¶é—´è¡¨', 'è§„åˆ’æ­¥éª¤',
    'åˆ¶å®šæ–¹æ¡ˆ', 'è§„åˆ’æ–¹æ¡ˆ', 'åˆ—å‡ºè®¡åˆ’', 'åˆ›å»ºæ–¹æ¡ˆ'
  ]
  
  // è¿‡æ»¤å’Œæ›¿æ¢æ­¥éª¤
  json.steps = json.steps
    .map(step => {
      // æ£€æŸ¥æ˜¯å¦åŒ…å«ç¦æ­¢çš„å…³é”®è¯
      const hasForbidden = forbiddenKeywords.some(keyword => step.includes(keyword))
      
      if (hasForbidden) {
        // å°è¯•æå–å…³é”®è¯åçš„å…·ä½“è¡ŒåŠ¨ï¼Œæˆ–è€…æ›¿æ¢ä¸ºæ›´å…·ä½“çš„è¡ŒåŠ¨
        // ä¾‹å¦‚ï¼š"ç¬¬2å‘¨ï¼šåˆ¶å®šå†…å®¹è®¡åˆ’" -> "ç¬¬2å‘¨ï¼šæ ¹æ®å·²ç¡®å®šçš„é¢†åŸŸï¼Œå®Œå–„æœ¬å‘¨3æ¡è§†é¢‘è„šæœ¬ï¼Œå¹¶æ’æœŸæ‹æ‘„"
        
        // å¦‚æœåŒ…å«"åˆ¶å®šå†…å®¹è®¡åˆ’"ï¼Œæ›¿æ¢ä¸ºå…·ä½“çš„åˆ›ä½œè¡ŒåŠ¨
        if (step.includes('åˆ¶å®šå†…å®¹è®¡åˆ’') || step.includes('è§„åˆ’å†…å®¹')) {
          return step.replace(/åˆ¶å®šå†…å®¹è®¡åˆ’|è§„åˆ’å†…å®¹/g, 'æ ¹æ®å·²ç¡®å®šçš„é¢†åŸŸï¼Œå®Œå–„æœ¬å‘¨è§†é¢‘è„šæœ¬ï¼Œå¹¶æ’æœŸæ‹æ‘„')
        }
        
        // å¦‚æœåŒ…å«"åˆ¶å®šè®­ç»ƒè®¡åˆ’"ï¼Œæ›¿æ¢ä¸ºå…·ä½“çš„è®­ç»ƒè¡ŒåŠ¨
        if (step.includes('åˆ¶å®šè®­ç»ƒè®¡åˆ’')) {
          return step.replace(/åˆ¶å®šè®­ç»ƒè®¡åˆ’/g, 'ä¸‹è½½è®­ç»ƒAppï¼Œé€‰æ‹©è®­ç»ƒè¯¾ç¨‹ï¼Œå¼€å§‹æ‰§è¡Œè®­ç»ƒ')
        }
        
        // å¦‚æœåŒ…å«"åˆ¶å®šå­¦ä¹ è®¡åˆ’"ï¼Œæ›¿æ¢ä¸ºå…·ä½“çš„å­¦ä¹ è¡ŒåŠ¨
        if (step.includes('åˆ¶å®šå­¦ä¹ è®¡åˆ’')) {
          return step.replace(/åˆ¶å®šå­¦ä¹ è®¡åˆ’/g, 'é€‰æ‹©å­¦ä¹ èµ„æºï¼Œå¼€å§‹å­¦ä¹ ')
        }
        
        // å…¶ä»–æƒ…å†µï¼Œå°è¯•æå–æ—¶é—´éƒ¨åˆ†ï¼Œæ›¿æ¢ä¸º"å¼€å§‹æ‰§è¡Œ"
        const timeMatch = step.match(/^(ç¬¬[^ï¼š:]+[ï¼š:])/)
        if (timeMatch) {
          return timeMatch[1] + 'å¼€å§‹æ‰§è¡Œå…·ä½“è¡ŒåŠ¨ï¼ˆè¯·æ ¹æ®ä¸Šä¸‹æ–‡è¡¥å……å…·ä½“å†…å®¹ï¼‰'
        }
        
        // å¦‚æœæ— æ³•æ›¿æ¢ï¼Œç›´æ¥ç§»é™¤è¿™ä¸ªæ­¥éª¤
        return null
      }
      
      return step
    })
    .filter(step => step !== null && step.trim() !== '') // ç§»é™¤ç©ºæ­¥éª¤
  
  // å¦‚æœè¿‡æ»¤åæ­¥éª¤å¤ªå°‘ï¼Œä¿ç•™åŸå§‹æ­¥éª¤ä½†ç»™å‡ºè­¦å‘Š
  if (json.steps.length < 3) {
    console.warn('âš ï¸ è¿‡æ»¤åæ­¥éª¤è¿‡å°‘ï¼Œä¿ç•™åŸå§‹æ­¥éª¤')
    // é‡æ–°è§£æï¼Œä¸è¿›è¡Œè¿‡æ»¤
    const originalJson = parseJSON(content)
    json.steps = originalJson.steps || []
  }
  
  return json
}
